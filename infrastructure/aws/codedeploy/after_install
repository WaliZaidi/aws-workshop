#!/bin/bash

# Install PostgreSQL devel libraries
sudo yum install -y postgresql-devel

# Add pg_config to path 
export PATH="$PATH:/usr/pgsql-12/bin"

# Create log directories
mkdir -p /var/log/gunicorn
mkdir -p /var/log/django 
mkdir -p /var/www/conduit/static/

# Install app dependencies
cd /deploy/backend || exit 2
pipenv install

# Configure environment
AWS_DEFAULT_REGION="$(curl -s http://169.254.169.254/latest/dynamic/instance-identity/document | jq -r .region)"
export AWS_DEFAULT_REGION
DJANGO_SETTINGS_MODULE='conduit.settings.ec2'  
export DJANGO_SETTINGS_MODULE

# Run database migrations
pipenv run python manage.py migrate

# Collect static files 
pipenv run python manage.py collectstatic --no-input
